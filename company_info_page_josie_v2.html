<html>
<!-- https://apexcharts.com/javascript-chart-demos/dashboards/modern/ -->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"> <!-- input form style -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"/>
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>

  <link rel="stylesheet" href="styles.css?v=2" />  <!-- general css style -->

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  
  <style>
    /* Remove list style from nav tabs */
    .nav-tabs {
      list-style: none;
      padding-left: 0;
    }
    .nav-tabs .nav-item {
      list-style: none;
    }
    /* Add padding at bottom to create buffer */
    #wrapper {
      padding-bottom: 50px;
    }
  </style>

  <title>Company Information</title>

</head>

<body>

  <div id="wrapper">
      <div class="content-area">
        <div class="container-fluid">

 <!-- https://www.wrappixel.com/templates/materialm-free-bootstrap-admin/ -->

      <!-- Navbar -->
      <nav class="navbar navbar-light" style="display: flex; justify-content: space-between; align-items: center;">
        <!-- Logo -->
        <a class="navbar" href="landing_page_josie.html">
          <img src="logo.png" alt="INSERT LOGO HERE" style="max-height: 50px; max-width: 200px; height: auto;" />
        </a>
        <!-- Links -->
        <div style="display: flex; gap: 15px;">
          <a href="company_info_page_josie_v2.html" class="navbar">
              Company Info
          </a>
          <a href="#" class="navbar">
              Disruptions
          </a>
        </div>
      </nav>
        
     <!-- Page Title --> 
    <h3>Company Information</h3>

  <div class="box shadow">
    <!-- This form is used to get user input for the company name and date range -->
    <form action= "" onsubmit="showCustomer()">
        <div style="display: grid; grid-template-columns: 3fr 1fr 1fr auto; gap: 10px; align-items: end;">
          <input type= "text" name= "Company_name" id= "company" placeholder= "Enter a company name" >
          <input type="date" name="date1" id="date1" placeholder = "Enter starting date">
          <input type= "date" name ="date2"id="date2" placeholder = "Enter ending date">
          <input type= "submit" name = "submit-btn" value="Search">
        </div>
    </form>
  </div>
    

  <script>
    // This function is in a script tag, indicating javascript, it is called when we
    // click the submit button on the form above.
    function showCustomer() {
      // These 3 strings are retrieved from the table above and joined into one string
      // separated by commas in the format the php file expects to find after the ?q=
      // part. 

      // This part gets the strings from the table.
      str = document.getElementById("company").value.trim();
      xt = document.getElementById("date1").value;
      yt = document.getElementById("date2").value;

      // Validate dates
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time to midnight for accurate comparison
      
      const startDate = new Date(xt);
      const endDate = new Date(yt);

      // Check if end date is before start date
      if (endDate < startDate) {
        alert("Error: The ending date cannot be before the starting date.");
        event.preventDefault();
        return;
      }

      // Check if either date is after today
      if (startDate > today) {
        alert("Error: The starting date cannot be after today's date.");
        event.preventDefault();
        return;
      }

      if (endDate > today) {
        alert("Error: The ending date cannot be after today's date.");
        event.preventDefault();
        return;
      }

      // This is how you join the strings into one big one.
      str = xt + "|" + yt + "|" + str;
      console.log(str);
      


      // This thing is weird and you don't always need it, but I think you need it specifically
      // for submit button based pages.
      event.preventDefault();

      // Here is where we start defining the XHTTP request that JS uses to call the php file 
      // with the variables.
      var xhttp;
      if (str == "") {
        // If the table variable/query variable is empty, make sure we're not displaying anything in temp. 
        // This isn't necessary in this example, but could be useful for particular configurations.
        document.getElementById("temp").innerHTML = "";
        return;
      }
      // this is where we define the actual request.
      xhttp = new XMLHttpRequest();

      // This function is called when the request loads from the php file.
      xhttp.onload = function () {
        // This if statement checks if we're ready and the php file returned a "working"
        // result (i.e. html status code 200, look this up if curious or confused.)
        if (this.readyState == 4 && this.status == 200) {

          // Since we have our php file returning the code in JSON, we need to parse the string as JSON.
          // this produces a list of Key-Value-Pairs, which are indexed by the key names, which we need to grab from
          // xt and yt variable from before. We do this, in this section of the code eval(`item.${xt}`) } below.
          //nsole.log(this.responseText);
          var temp = JSON.parse(this.responseText);
          console.log(temp);
          // https://stackoverflow.com/questions/14643617/create-table-using-javascript
          function makeTableHTML(myArray) {
            if (!myArray || myArray.length === 0) {
              return "None";
            }
            var result = "<div style='display: grid; grid-template-columns: 1fr 1fr; gap: 10px;'>";
            for(var i=0; i<myArray.length; i++) {
                result += "<div>"+myArray[i]+"</div>";
            }
            result += "</div>";
            return result;
          }
          //https://stackoverflow.com/questions/14643617/create-table-using-javascript
          function makeTableHTMLColoumns(myArray) {
            if (!myArray || myArray.length === 0) {
              return "None";
            }
            var result = "<div style='display: grid; grid-template-columns: 1fr; gap: 10px;'>";
            for(var i=0; i<myArray.length; i++) {
                result += "<div>" + myArray[i] + "</div>";
            }
            result +="</div>";
            return result;
          }



          //https://www.apexcharts.com/javascript-chart-demos/pie-charts/monochrome-pie/
          function createpiecharts(data1,data2, id, legendlabel, borderwidth, hoveroffset) {
            if (window.myPieChart) {
              window.myPieChart.destroy();
            }
            
            // Random color selection for monochrome theme
            const colors = ['#008FFB', '#00E396', '#FEB019', '#FF4560', '#775DD0', '#546E7A', '#26a69a', '#FF6178'];
            const randomColor = colors[Math.floor(Math.random() * colors.length)];
            data2=data2.map(Number);
            
            var options = {
              series: data2,
              chart: {
                width: '100%',
                height: 350,
                type: 'pie',
              },
              labels: data1,
              theme: {
                monochrome: {
                  enabled: true,
                  color: randomColor,
                  shadeTo: 'light',
                  shadeIntensity: 0.65
                },
              },
              plotOptions: {
                pie: {
                  dataLabels: {
                    offset: -5,
                  },
                },
              },
              dataLabels: {
                formatter(val, opts) {
                  const name = opts.w.globals.labels[opts.seriesIndex]
                  return [name, val.toFixed(1) + '%']
                },
              },
              legend: {
                show: true,
                position: 'bottom',
              },
            };
            
            window.myPieChart = new ApexCharts(document.querySelector("#" + id), options);
            window.myPieChart.render();
          }



          //https://apexcharts.com/javascript-chart-demos/line-charts/basic/
          function createlinecharts(xdata,ydata,legendlabel,bordercolor, tension, sizex, xlabel,ylabel, sizey, id) {
            if (window.myLineChart) {
              window.myLineChart.destroy();
            }
            
            var options = {
              series: [{
                name: legendlabel,
                data: ydata
              }],
              chart: {
                height: 350,
                type: 'line',
                zoom: {
                  enabled: false
                }
              },
              dataLabels: {
                enabled: false
              },
              stroke: {
                curve: 'straight',
                colors: [bordercolor]
              },
              grid: {
                row: {
                  colors: ['#f3f3f3', 'transparent'],
                  opacity: 0.5
                },
              },
              xaxis: {
                categories: xdata,
                title: {
                  text: xlabel
                }
              },
              yaxis: {
                title: {
                  text: 'Financial Health Score'
                }
              }
            };

            window.myLineChart = new ApexCharts(document.querySelector("#" + id), options);
            window.myLineChart.render();
          }


          const companyName = temp[0][0][0];
          const tier = temp[0][0][1];
          const type = temp[0][0][2];
          const locationText = `${temp[0][0][3]}, ${temp[0][0][4]}, ${temp[0][0][5]}`;

          let html = `<h3></br>${companyName}</h3>`;
          
          // Tab navigation
          html += `<ul class="nav nav-tabs mt-3" id="companyTabs" role="tablist">`;
          html += `  <li class="nav-item">`;
          html += `    <a class="nav-link active" id="info-tab" data-toggle="tab" href="#info" role="tab">Company Information</a>`;
          html += `  </li>`;
          html += `  <li class="nav-item">`;
          html += `    <a class="nav-link" id="financial-tab" data-toggle="tab" href="#financial" role="tab">Financial Health</a>`;
          html += `  </li>`;
          html += `  <li class="nav-item">`;
          html += `    <a class="nav-link" id="dependencies-tab" data-toggle="tab" href="#dependencies" role="tab">Dependencies</a>`;
          html += `  </li>`;
          
          if (type == "Manufacturer") {
            html += `  <li class="nav-item">`;
            html += `    <a class="nav-link" id="products-tab" data-toggle="tab" href="#products" role="tab">Products</a>`;
            html += `  </li>`;
          } else if (type == "Distributor") {
            html += `  <li class="nav-item">`;
            html += `    <a class="nav-link" id="routes-tab" data-toggle="tab" href="#routes" role="tab">Routes</a>`;
            html += `  </li>`;
          }
          
          html += `</ul>`;
          
          // Tab content
          html += `<div class="tab-content mt-3" id="companyTabsContent">`;
          
          // Company Information Tab
          html += `  <div class="tab-pane fade show active" id="info" role="tabpanel">`;
          
          // Determine if company has 4th box (Manufacturer/Distributor) or only 3 (other types)
          const hasCapacityOrRoutes = (type == "Manufacturer" || type == "Distributor");
          const topColSize = hasCapacityOrRoutes ? "col-md-3" : "col-md-4";
          
          html += `    <div class="row sparkboxes mt-4">`;
          html += `      <div class="${topColSize}"><div class="box box1 shadow"><h6>Tier</h6>${tier}</div></div>`;
          html += `      <div class="${topColSize}"><div class="box box2 shadow"><h6>Type</h6>${type}</div></div>`;
          html += `      <div class="${topColSize}"><div class="box box3 shadow"><h6>Location</h6>${locationText}</div></div>`;
          
          if (type == "Manufacturer") {
            const capacity = temp[0][1];
            html += `      <div class="col-md-3"><div class="box box4 shadow"><h6>Capacity</h6>${capacity}</div></div>`;
          } else if (type == "Distributor") {
            let Distributors = temp[0][1];
            const routesCount = Array.isArray(Distributors) ? Distributors.length : 0;
            html += `      <div class="col-md-3"><div class="box box4 shadow"><h6>Routes</h6>${routesCount}</div></div>`;
          }
          
          html += `    </div>`; // close first sparkboxes row
          
          // Add second row for delivery metrics
          const ontimeDelivery = temp[0][0][6];
          const avgDelay = temp[0][0][7];
          const stdDevDelay = temp[0][0][8];
          
          html += `    <div class="row sparkboxes mt-3">`;
          html += `      <div class="col-md-4"><div class="box box5 shadow"><h6>On-Time Delivery</h6> DELIVERY %</div></div>`;
          html += `      <div class="col-md-4"><div class="box box6 shadow"><h6>Average Delay</h6> AVG DELAY </div></div>`;
          html += `      <div class="col-md-4"><div class="box box7 shadow"><h6>Std Dev of Delay</h6> STD DEV </div></div>`;
          html += `    </div>`;     // close second sparkboxes row
          
          html += `  </div>`;       // close Company Information tab
          
          // Financial Health Tab
          html += `  <div class="tab-pane fade" id="financial" role="tabpanel">`;
          html += `    <div class="row mt-4 mb-5">`;
          html += `      <div class="col-md-12">`;
          html += `        <div class="box shadow">`;
          html += `          <h6>Financial Health Status</h6> <div id="myChartLine"></div>`;
          html += `        </div>`;
          html += `      </div>`;
          html += `    </div>`;
          html += `  </div>`;       // close Financial Health tab
          
          // Dependencies Tab
          html += `  <div class="tab-pane fade" id="dependencies" role="tabpanel">`;
          html += `    <div class="row mt-4 mb-5">`;
          
          if (type == "Manufacturer") {
            let whoDependsOnThem = temp[0][7];
            let whoTheyDependOn = temp[0][8];
            html += `      <div class="col-md-6"><div class="box shadow"><h6>Who Depends on Them</h6>${makeTableHTMLColoumns(whoDependsOnThem)}</div></div>`;
            html += `      <div class="col-md-6"><div class="box shadow"><h6>Who They Depend On</h6>${makeTableHTMLColoumns(whoTheyDependOn)}</div></div>`;
          } else {
            let whoDependsOnThem = temp[0][4];
            let whoTheyDependOn = temp[0][5];
            html += `      <div class="col-md-6"><div class="box shadow"><h6>Who Depends on Them</h6>${makeTableHTMLColoumns(whoDependsOnThem)}</div></div>`;
            html += `      <div class="col-md-6"><div class="box shadow"><h6>Who They Depend On</h6>${makeTableHTMLColoumns(whoTheyDependOn)}</div></div>`;
          }
          
          html += `    </div>`;
          html += `  </div>`;       // close Dependencies tab
          
          // Products Tab (Manufacturer only)
          if (type == "Manufacturer") {
            let products = temp[0][2];
            html += `  <div class="tab-pane fade" id="products" role="tabpanel">`;
            html += `    <div class="row mt-4 mb-5">`;
            html += `      <div class="col-md-8">`;
            html += `        <div class="box shadow"><h6>Products</h6>${makeTableHTML(products)}</div>`;
            html += `      </div>`;
            html += `      <div class="col-md-4">`;
            html += `        <div class="box shadow" style="height: 100%;">`;
            html += `          <h6>Categories</h6> <div id="myChart"></div>`;
            html += `        </div>`;
            html += `      </div>`;
            html += `    </div>`;
            html += `  </div>`;     // close Products tab
            
            // Clear pie chart for non-manufacturers
            if (window.myPieChart) {
              window.myPieChart.destroy();
              window.myPieChart = null;
            }
          } else if (type == "Distributor") {
            // Routes Tab (Distributor only)
            let Distributors = temp[0][1];
            html += `  <div class="tab-pane fade" id="routes" role="tabpanel">`;
            html += `    <div class="row mt-4 mb-5">`;
            html += `      <div class="col-md-12">`;
            html += `        <div class="box shadow"><h6>Routes</h6>${makeTableHTML(Distributors)}</div>`;
            html += `      </div>`;
            html += `    </div>`;
            html += `  </div>`;     // close Routes tab
            
            // Clear pie chart for non-manufacturers
            if (window.myPieChart) {
              window.myPieChart.destroy();
              window.myPieChart = null;
            }
          } else {
            // Clear pie chart for non-manufacturers
            if (window.myPieChart) {
              window.myPieChart.destroy();
              window.myPieChart = null;
            }
          }
          
          html += `</div>`;         // close tab-content

          var tempEl = document.getElementById("temp");
          tempEl.innerHTML = html;
          
          // Create charts AFTER HTML is inserted into DOM
          if (type == "Manufacturer") {
            createpiecharts(temp[0][3], temp[0][4], "myChart", '% of each category', 2, 4);
          }
          createlinecharts(temp[0][5], temp[0][6], 'Financial Health', 'rgb(75, 192, 192)', 0.1, 14, 'Quarter / Year', 'Health Score', 14, "myChartLine");
        }
      };

      

      // This portion actually runs the HTTP request to the php file using the variables set in the table
      // and concatenated on line 49 into the str variable which contains x_variable,y_variable,table
      // but replace the placeholders with whatever variables/table  you're trying to query.
      var url = "company_info_output.php?q=" + encodeURIComponent(str);
      console.log(url);
      xhttp.open("GET", url, true);
      xhttp.send();
    }
  </script>

  <div id="temp"></div>


        </div>
      </div>
    </div>
    
    <!-- Bootstrap JS and dependencies for tab functionality -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>
  </body>

<!-- https://web.ics.purdue.edu/~brumfij/company_info_page_josie_v2 -->

</html>