<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>

  <title>Company Information</title>

  <style>
    #temp {
      max-width: length-percentage 90%;
      margin: 2rem auto;
      padding: 1.5rem;
      background: #f9f9f9;
      border-radius: 8px;
      line-height: 1.6;
    }
    #temp div {
      margin-bottom: 0.75rem;
    }
    #temp table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    #temp td, #temp th {
      padding: 0.75rem;
      border: 1px solid #ddd;
      text-align: left;
    }
    #temp tr:nth-child(even) {
      background: #f0f0f0;
    }
    #temp strong {
      color: #333;
      font-weight: 600;
    }
    #chartsWrapper {
      display: none;
      max-width: 1200px;
      margin: 2rem auto;
      display: grid;
      grid-template-columns: 2.5fr 1fr;
      gap: 2rem;
      align-items: center;
    }
    /* When pie chart is hidden, line chart takes full width */
    #chartsWrapper:has(#pieChartContainer:not([style*="display: block"])) {
      grid-template-columns: 1fr;
    }
    #pieChartContainer {
      padding: 1.5rem;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #pieChartContainer h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      text-align: center;
      color: #333;
    }
    #pieChartContainer canvas {
      width: 100%;
      max-width: 280px;
      height: auto;
      display: block;
    }
    #lineChartContainer {
      padding: 1.5rem;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    #lineChartContainer h3 {
      margin-top: 0;
      margin-bottom: 1rem;
      text-align: center;
      color: #333;
    }
    #lineChartContainer canvas {
      width: 100%;
      height: auto;
      display: block;
    }
    .info-cards-normal{
      display: grid;
      grid-template-columns: 0.8fr 1fr 1.5fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .info-cards-manufacturer {
      display: grid;
      grid-template-columns: 0.8fr 1fr 1.5fr .8fr;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .info-card {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid #0066cc;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }
    .info-card strong {
      display: block;
      color: #0066cc;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.5rem;
    }
    .info-card div {
      font-size: 1.1rem;
      color: #333;
      word-wrap: break-word;
    }
  </style>

</head>

<body>
      <!-- https://www.wrappixel.com/templates/materialm-free-bootstrap-admin/ -->
      <header class="bg-white">
      <div class="container">
        <!-- Start Header -->
        <div class="header">
          <nav class="navbar navbar-expand-md navbar-light px-0">
            <!-- Logo -->
            <a class="navbar-brand d-flex" href="index.html">
              <img src="Logo" alt="INSERT LOGO HERE" />
            </a>
            <!-- Button -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
              data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false"
              aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
              Random Button
            </button>
            <!-- Navbar Links -->
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav ms-auto py-3 py-md-0">
                <li class="nav-item pe-0 pe-md-3">
                  <a href="https://www.wrappixel.com/templates/materialm-free-bootstrap-admin/"
                    class="btn btn-custom btn-outline-primary d-block d-md-inline-block" target="_blank">Optional Link #1</a>
                </li>
                <li class="nav-item mt-3 mt-md-0">
                  <a href="https://www.wrappixel.com/templates/materialm-admin-dashboard-template/?ref=33"
                    class="btn btn-custom btn-primary d-block d-md-inline-block" target="_blank">Optional Link #2</a>
                </li>
              </ul>
            </div>
          </nav>
        </div>
        <!-- End Header -->
      </div>
    </header>

    <div class="content-wrapper">
      <section class="spacer bg-light">
        <div class="container">
          <!-- Page Title -->
          <div class="row justify-content-md-center">
            <div class="col-md-8 text-center">
              <h2 class="mb-3">Company Information</h2>
              <p class="lead mb-0">Enter a company name and date range to see information about the company.</p>
            </div>
          </div>
          <!-- Company Search Form -->
          <form action= "" onsubmit="showCustomer()">
            <input type= "text" name= "Company_name" id= "company" placeholder= "Enter a company name">
            <input type="date" name="date1" id="date1" placeholder = "Enter starting date">
            <input type= "date" name ="date2"id="date2" placeholder = "Enter ending date">
            <input type= "submit" name = "submit-btn" value="Search">
          </form>

  <!-- This Div with id=tester is used to act as a placeholder for the plot. -->
  <div id="tester" style="width:600px;height:250px;"></div>

  <script>
    // Global chart reference so we can destroy it before creating a new one
    let myChart = null;

    // This function is in a script tag, indicating javascript, it is called when we
    // click the submit button on the form above.
    function showCustomer() {
      // These 3 strings are retrieved from the table above and joined into one string
      // separated by commas in the format the php file expects to find after the ?q=
      // part. 

      // This part gets the strings from the table.
      str = document.getElementById("company").value;
      xt = document.getElementById("date1").value;
      yt = document.getElementById("date2").value;


      // This is how you join the strings into one big one.
      str = xt + "|" + yt + "|" + str;
      console.log(str);

      // This thing is weird and you don't always need it, but I think you need it specifically
      // for submit button based pages.
      event.preventDefault();

      // Here is where we start defining the XHTTP request that JS uses to call the php file 
      // with the variables.
      var xhttp;
      if (str == "") {
        // If the table variable/query variable is empty, make sure we're not displaying anything in temp. 
        // This isn't necessary in this example, but could be useful for particular configurations.
        document.getElementById("temp").innerHTML = "";
        return;
      }
      // this is where we define the actual request.
      xhttp = new XMLHttpRequest();

      // This function is called when the request loads from the php file.
      xhttp.onload = function () {
        // This if statement checks if we're ready and the php file returned a "working"
        // result (i.e. html status code 200, look this up if curious or confused.)
        if (this.readyState == 4 && this.status == 200) {

          // Since we have our php file returning the code in JSON, we need to parse the string as JSON.
          // this produces a list of Key-Value-Pairs, which are indexed by the key names, which we need to grab from
          // xt and yt variable from before. We do this, in this section of the code eval(`item.${xt}`) } below.
          //nsole.log(this.responseText);
          var temp = JSON.parse(this.responseText);
          console.log(temp);
          // https://stackoverflow.com/questions/14643617/create-table-using-javascript
          function makeTableHTML(myArray) {
            var result = "<table border=1>";
            for(var i=0; i<myArray.length; i++) {
                result += "<td>"+myArray[i]+"</td>";
            }
            result += "</table>";
            return result;
          }
          //https://stackoverflow.com/questions/14643617/create-table-using-javascript
          function makeTableHTMLColoumns(myArray) {
            var result = "<table border=1><tr>";
            for(var i=0; i<myArray.length; i++) {
                result += "<tr><td>" + myArray[i] + "</td></tr>";
            }
            result +="</table>";
            return result;
          }
      //https://www.chartjs.org/docs/latest/charts/doughnut.html
          function createpiecharts(data1,data2, id, legendlabel, borderwidth, hoveroffset) {
            document.getElementById("chartsWrapper").style.display = "grid";
            document.getElementById("pieChartContainer").style.display = "block";
            let color = [];
            for (let i = 0; i < data1.length; i++) {
              color.push(`rgb(${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)},${Math.floor(Math.random()*255)})`);
            } 
            var canvas = document.getElementById(id);
            if (!canvas) return;
            var ctx = canvas.getContext('2d');
            myChart = new Chart(ctx, {
              type: 'pie',
              data: {
              labels: data1,
              datasets: [{
              label: legendlabel,
              data: data2,
              borderWidth: borderwidth,
              backgroundColor: color,
              hoverOffset: hoveroffset
              }]
            },
              options: {
                maintainAspectRatio: true,
                aspectRatio: 1,
                plugins: {
                  legend: { position: 'bottom' }
                }
              }
            });
          }

          function createlinecharts(xdata,ydata,legendlabel,bordercolor, tension, sizex, xlabel,ylabel, sizey, id, hidePieChart = false) {
            document.getElementById("chartsWrapper").style.display = "grid";
            document.getElementById("lineChartContainer").style.display = "block";
            // Hide pie chart container if not needed
            if (hidePieChart) {
              document.getElementById("pieChartContainer").style.display = "none";
            }
            var vtx = document.getElementById(id);
            if (!vtx) return;
            var ctx = vtx.getContext('2d');
            myChart = new Chart(ctx, {
              type: 'line',
              data: {
                labels: xdata,
                datasets: [{
                  label: legendlabel,
                  data: ydata,
                  fill: false,
                  borderColor: bordercolor,
                  tension: tension
                }]
              },
              options: {
                maintainAspectRatio: true,
                aspectRatio: 2.5,
                scales: {
                  x: {
                    ticks: {
                      display: true
                    }
                  },
                  y: {
                    beginAtZero: true
                  }
                }
              }
            });
          }

          function deleteChart(chart) {
            if (!chart) {
              document.getElementById("chartsWrapper").style.display = "none";
              return false;
            }
            if (typeof chart.destroy === 'function') {
              try { chart.destroy(); } catch (e) { /* ignore */ }
            }
            document.getElementById("chartsWrapper").style.display = "none";
          }

          let html = `<h2 style="margin-bottom: 1.5rem; color: #333;">${temp[0][0][0]}</h2>`;

          if (temp[0][0][2]=="Manufacturer"){
            html += `<div class="info-cards-manufacturer">
              <div class="info-card"><strong>Tier</strong><div>${temp[0][0][1]}</div></div>
              <div class="info-card"><strong>Type</strong><div>${temp[0][0][2]}</div></div>
              <div class="info-card"><strong>Location</strong><div>${temp[0][0][3]}, ${temp[0][0][4]}, ${temp[0][0][5]}</div></div>
              <div class="info-card"><strong>Capacity</strong><div>${temp[0][1]}</div></div>
            </div>`;
            html+= `<div><strong>Products:</strong></div>`;
            let products = temp[0][2];
            html += makeTableHTML(products);
            let categorie = temp[0][3];
            let categoriespercents = temp[0][4];
            //html += "<table>"
            deleteChart(myChart);
            createpiecharts(temp[0][3], temp[0][4], "myChart", '% of each category', 2, 4);
          }
          else if (temp[0][0][2]=="Distributor"){
            html += `<div class="info-cards-normal">
              <div class="info-card"><strong>Tier</strong><div>${temp[0][0][1]}</div></div>
              <div class="info-card"><strong>Type</strong><div>${temp[0][0][2]}</div></div>
              <div class="info-card"><strong>Location</strong><div>${temp[0][0][3]}, ${temp[0][0][4]}, ${temp[0][0][5]}</div></div>
            </div>`;
            html+= `<div><strong>Routes:</strong></div>`;
            let Distributors = temp[0][1];
            html += makeTableHTMLColoumns(Distributors);
            deleteChart(myChart);
          }
          else if (temp[0][0][2]=="Retailer"){
            html += `<div class="info-cards-normal">
              <div class="info-card"><strong>Tier</strong><div>${temp[0][0][1]}</div></div>
              <div class="info-card"><strong>Type</strong><div>${temp[0][0][2]}</div></div>
              <div class="info-card"><strong>Location</strong><div>${temp[0][0][3]}, ${temp[0][0][4]}, ${temp[0][0][5]}</div></div>
            </div>`;
            deleteChart(myChart);
          }

          var tempEl = document.getElementById("temp");
          tempEl.innerHTML = html;
          // Only hide pie chart for non-manufacturers
          const isManufacturer = temp[0][0][2] === "Manufacturer";
          createlinecharts(temp[0][5], temp[0][6],'Financial Health', 'rgb(75, 192, 192)', 0.1, 14, 'Quarter / Year', 'Health Score', 14, "myChartLine", !isManufacturer);
        }
      };

      

      // This portion actually runs the HTTP request to the php file using the variables set in the table
      // and concatenated on line 49 into the str variable which contains x_variable,y_variable,table
      // but replace the placeholders with whatever variables/table  you're trying to query.
      var url = "company_info_output.php?q=" + encodeURIComponent(str);
      console.log(url);
      xhttp.open("GET", url, true);
      xhttp.send();
    }
  </script>

          <div id="temp"></div>
          <div id="chartsWrapper">
            <div id="lineChartContainer">
              <h3>Financial Health</h3>
              <canvas id="myChartLine"></canvas>
            </div>
            <div id="pieChartContainer">
              <h3>Category Breakdown</h3>
              <canvas id="myChart"></canvas>
            </div>
          </div>

        </div>
      </section>
    </div>

  
</body>

</html>