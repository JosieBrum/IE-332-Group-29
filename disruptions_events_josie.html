<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"> <!-- input form style -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"/>
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>

  <link rel="stylesheet" href="template/apex_charts_material/assets/styles.css?v=3" />  <!-- general css style -->

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <script src="chart-utils.js"></script>
  
  <style>
    /* Remove list style from nav tabs */
    .nav-tabs {
      list-style: none;
      padding-left: 0;
    }
    .nav-tabs .nav-item {
      list-style: none;
    }
    /* Add padding at bottom to create buffer */
    #wrapper {
      padding-bottom: 50px;
    }
  </style>

  <title>Disruption Events</title>

</head>

<body>

  <!-- Vertical Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <img src="logo.png" alt="INSERT LOGO HERE" />
    </div>
    <ul class="nav-links">
      <li><a href="company_info_page_josie_v5.html">Company Information</a></li>
      <li><a href="disruptions_events_josie.html" class="active">Disruption Events</a></li>
      <li><a href="company_transactions_page_josie.html">Company Transactions</a></li>
      <li><a href="distributor_transactions_page_josie.html">Distributor Transactions</a></li>
      <li><a href="login_page_josie.html" style="color: #ff4560;">Log Out</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div id="wrapper">
      <div class="content-area">
        <div class="container-fluid">

     <!-- Page Title --> 
    <h3>Disruption Events</h3>

  <div class="box shadow">
    <!-- This form is used to search for disruption events -->
    <form action= "" onsubmit="showCustomer()">
        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
          <select name="searchType" id="searchType" onchange="updateSearchFields()" required>
            <option value="">Select search type</option>
            <option value="company">Company</option>
            <option value="continent">Continent</option>
            <option value="country">Country</option>
            <option value="tier">Tier</option>
            <option value="tier_continent">Tier & Continent</option>
            <option value="tier_country">Tier & Country</option>
          </select>
          
          <div id="searchFields"></div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
            <input type="date" name="date1" id="date1" placeholder = "Enter starting date">
            <input type= "date" name ="date2" id="date2" placeholder = "Enter ending date">
            <input type= "submit" name = "submit-btn" value="Search">
          </div>
        </div>
        <div id="errorMessage" class="mt-3" style="color: red; display: none;"></div>
    </form>
  </div>

  <!-- Tabs for different chart views (hidden until search is performed) -->
  <div class="mt-4" id="chartTabsContainer" style="display: none;">
    <ul class="nav nav-tabs" id="chartTabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="df-tab" data-toggle="tab" href="#df" role="tab">DF</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="art-tab" data-toggle="tab" href="#art" role="tab">ART</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="hdr-tab" data-toggle="tab" href="#hdr" role="tab">HDR</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="td-tab" data-toggle="tab" href="#td" role="tab">TD</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="rrc-tab" data-toggle="tab" href="#rrc" role="tab">RRC</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="dsd-tab" data-toggle="tab" href="#dsd" role="tab">DSD</a>
      </li>
    </ul>

    <div class="tab-content mt-3" id="chartTabsContent">
      <div class="tab-pane fade show active" id="df" role="tabpanel">
        <h5 class="mt-3">Disruption Frequency</h5>
        <div class="box shadow">
          <div id="dfChart"></div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="art" role="tabpanel">
        <h5 class="mt-3">Average Recovery Time</h5>
        <div class="box shadow">
          <p>Content coming soon</p>
        </div>
      </div>
      
      <div class="tab-pane fade" id="hdr" role="tabpanel">
        <h5 class="mt-3">High-Impact Disruption Rate</h5>
        <div class="row mt-4 mb-5">
          <div class="col-md-6">
            <div class="box shadow" style="min-height: 450px; padding-bottom: 40px;">
              <div id="hdrTotalDisplay" style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 5px;">Loading...</div>
              <h6>Contribution to HDR by Company</h6>
              <div id="hdrPieChart"><p style="text-align: center; padding: 40px; color: #6c757d;">Loading chart...</p></div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="box shadow">
              <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; font-weight: bold; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 10px;">
                <div>Company</div>
                <div>HDR</div>
              </div>
              <div id="hdrTableBody"><p style="text-align: center; padding: 20px; color: #6c757d;">Loading...</p></div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="td" role="tabpanel">
        <h5 class="mt-3">Total Downtime</h5>
        <div class="box shadow">
          <p>Content coming soon</p>
        </div>
      </div>
      
      <div class="tab-pane fade" id="rrc" role="tabpanel">
        <h5 class="mt-3">Regional Risk Concentration</h5>
        <div class="box shadow">
          <div id="rrcError" style="display: none; padding: 20px; text-align: center; color: #856404; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
            <strong>Note:</strong> Regional Risk Concentration chart requires a country or continent to be selected in the search.
          </div>
          <div id="rrcChart"></div>
        </div>
      </div>
      
      <div class="tab-pane fade" id="dsd" role="tabpanel">
        <h5 class="mt-3">Disruption Severity Distribution</h5>
        <div class="box shadow">
          <div id="dsdChart"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- This Div with id=tester is used to act as a placeholder for the plot. -->
  <div id="tester" style="width:600px;height:250px;"></div>

  <script>
    function updateSearchFields() {
      const searchType = document.getElementById("searchType").value;
      const searchFieldsDiv = document.getElementById("searchFields");
      
      let html = '';
      
      switch(searchType) {
        case 'company':
          html = '<input type="text" name="company" id="company" placeholder="Enter company" required>';
          break;
        case 'continent':
          html = `<select name="continent" id="continent" required>
            <option value="">Select continent</option>
            <option value="Africa">Africa</option>
            <option value="Asia">Asia</option>
            <option value="Europe">Europe</option>
            <option value="North America">North America</option>
            <option value="Oceania">Oceania</option>
            <option value="South America">South America</option>
          </select>`;
          break;
        case 'country':
          html = '<input type="text" name="country" id="country" placeholder="Enter country" required>';
          break;
        case 'tier':
          html = `<select name="tier" id="tier" required>
            <option value="">Select tier</option>
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
          </select>`;
          break;
        case 'tier_continent':
          html = `<div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
            <select name="tier" id="tier" required>
              <option value="">Select tier</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <select name="continent" id="continent" required>
              <option value="">Select continent</option>
              <option value="Africa">Africa</option>
              <option value="Asia">Asia</option>
              <option value="Europe">Europe</option>
              <option value="North America">North America</option>
              <option value="Oceania">Oceania</option>
              <option value="South America">South America</option>
            </select>
          </div>`;
          break;
        case 'tier_country':
          html = `<div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
            <select name="tier" id="tier" required>
              <option value="">Select tier</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="3">3</option>
            </select>
            <input type="text" name="country" id="country" placeholder="Enter country" required>
          </div>`;
          break;
        default:
          html = '';
      }
      
      searchFieldsDiv.innerHTML = html;
    }
    
    function showCustomer() {
      // Clear previous error message
      const errorMessageDiv = document.getElementById("errorMessage");
      errorMessageDiv.style.display = "none";
      errorMessageDiv.textContent = "";
      
      // Clear all chart containers and reset to loading state
      document.getElementById("dfChart").innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">Loading chart...</p>';
      document.getElementById("dsdChart").innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">Loading chart...</p>';
      document.getElementById("hdrTotalDisplay").textContent = "Loading...";
      document.getElementById("hdrPieChart").innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">Loading chart...</p>';
      document.getElementById("hdrTableBody").innerHTML = '<p style="text-align: center; padding: 20px; color: #6c757d;">Loading...</p>';
      document.getElementById("rrcError").style.display = "none";
      document.getElementById("rrcChart").innerHTML = "";
      
      // Hide tabs container until search is successful
      document.getElementById("chartTabsContainer").style.display = "none";

      //https://code-boxx.com/javascript-fetch-get-query-params/
      var feilds = ["company", "tier", "country", "continent", "date1", "date2"];
      var inputs = {};
      for (var key = 0; key < feilds.length; key++) {
        if (document.getElementById(feilds[key])) {
          if (document.getElementById(feilds[key]).value != "") {
            inputs[feilds[key]] = document.getElementById(feilds[key]).value;
          }
        }
      }
      
      // Set default dates if not provided
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time to midnight for accurate comparison
      
      // If no end date provided, use today
      if (!inputs["date2"]) {
        const todayStr = today.toISOString().split('T')[0];
        inputs["date2"] = todayStr;
        document.getElementById("date2").value = todayStr;
      }
      
      // If no start date provided, use 2019-01-01 (start of database)
      if (!inputs["date1"]) {
        const dbStartDate = '2019-01-01';
        inputs["date1"] = dbStartDate;
        document.getElementById("date1").value = dbStartDate;
      }
      
      // Validate dates
      const startDate = new Date(inputs["date1"]);
      const endDate = new Date(inputs["date2"]);

      // Check if end date is before start date
      if (endDate < startDate) {
        errorMessageDiv.textContent = "The ending date cannot be before the starting date.";
        errorMessageDiv.style.display = "block";
        event.preventDefault();
        return;
      }

      // Check if either date is after today
      if (startDate > today) {
        errorMessageDiv.textContent = "The starting date cannot be after today's date.";
        errorMessageDiv.style.display = "block";
        event.preventDefault();
        return;
      }

      if (endDate > today) {
        errorMessageDiv.textContent = "The ending date cannot be after today's date.";
        errorMessageDiv.style.display = "block";
        event.preventDefault();
        return;
      }
      
      console.log(inputs);
      event.preventDefault();
      var xhttp;
      xhttp = new XMLHttpRequest();
      xhttp.onload = function () {
        if (this.readyState == 4 && this.status == 200) {
          var temp = JSON.parse(this.responseText);
          console.log(temp);
          
          // Validate company name if it was provided
          if (inputs["company"]) {
            const companyListAll = temp["Company Name List All: "];
            const enteredCompany = inputs["company"].trim();
            
            if (companyListAll && companyListAll.length > 0 && !companyListAll.includes(enteredCompany)) {
              const errorMessageDiv = document.getElementById("errorMessage");
              errorMessageDiv.textContent = "Company '" + enteredCompany + "' not found in database. Please check the spelling and try again.";
              errorMessageDiv.style.display = "block";
              return;
            }
          }
          
          // Validate country name if it was provided
          if (inputs["country"]) {
            const countryListAll = temp["Country Name List All: "];
            const enteredCountry = inputs["country"].trim();
            
            if (countryListAll && countryListAll.length > 0 && !countryListAll.includes(enteredCountry)) {
              const errorMessageDiv = document.getElementById("errorMessage");
              errorMessageDiv.textContent = "Country '" + enteredCountry + "' not found in database. Please check the spelling and try again.";
              errorMessageDiv.style.display = "block";
              return;
            }
          }
          
          // Show the tabs container after successful search
          document.getElementById("chartTabsContainer").style.display = "block";
          
          // Create DF bar chart
          if (temp["Company Name DF: "] && temp["DF: "]) {
            createBarChart("dfChart", {
              labels: temp["Company Name DF: "],
              values: temp["DF: "]
            }, {
              xAxisTitle: "Company",
              yAxisTitle: "Disruption Frequency"
            });
          }
          
          // Create DSD stacked bar chart
          if (temp["Company Name DSD: "] && temp["Low Count: "] && temp["Medium Count: "] && temp["High Count: "]) {
            createStackedBarChart("dsdChart", {
              categories: temp["Company Name DSD: "],
              series: [
                { name: "Low", data: temp["Low Count: "] },
                { name: "Medium", data: temp["Medium Count: "] },
                { name: "High", data: temp["High Count: "] }
              ]
            }, {
              xAxisTitle: "Company",
              yAxisTitle: "Count",
              colors: ['#00E396', '#FEB019', '#FF4560']
            });
          }
          
          // Create HDR visualizations
          if (temp["HRD Overall: "] && temp["Company Name HRD Percent: "] && temp["HDR Percents: "] && 
              temp["Company Name HRD: "] && temp["HDR Company Scores: "]) {
            
            // Display total HDR
            const totalHDR = Number(temp["HRD Overall: "][0]).toFixed(2);
            document.getElementById("hdrTotalDisplay").textContent = "Overall HDR: " + totalHDR + "%";
            
            // Check if all HDRs are zero
            const allHDRsZero = temp["HDR Company Scores: "].every(score => Number(score) === 0);
            
            // Create pie chart for HDR contribution by company (only if there are non-zero values)
            if (!allHDRsZero && temp["HDR Percents: "].some(val => val !== null && Number(val) > 0)) {
              createColorfulPieChart("hdrPieChart", {
                labels: temp["Company Name HRD Percent: "],
                values: temp["HDR Percents: "]
              });
            } else {
              document.getElementById("hdrPieChart").innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">All HDRs are zero.</p>';
            }
            
            // Create table for HDR company scores
            let tableHTML = '';
            for (let i = 0; i < temp["Company Name HRD: "].length; i++) {
              const score = Number(temp["HDR Company Scores: "][i]).toFixed(2);
              tableHTML += `<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; padding: 8px 10px; border-bottom: 1px solid #eee;">`;
              tableHTML += `<div>${temp["Company Name HRD: "][i]}</div>`;
              tableHTML += `<div>${score}</div>`;
              tableHTML += `</div>`;
            }
            document.getElementById("hdrTableBody").innerHTML = tableHTML;
          }
          
          // Handle RRC chart - show error if country/continent not provided
          const hasCountryOrContinent = inputs["country"] || inputs["continent"];
          if (hasCountryOrContinent) {
            document.getElementById("rrcError").style.display = "none";
            document.getElementById("rrcChart").style.display = "block";
            // TODO: Add RRC chart creation here when ready
          } else {
            document.getElementById("rrcError").style.display = "block";
            document.getElementById("rrcChart").style.display = "none";
          }
        }
      };
      //https://developer.mozilla.org/en-US/docs/Web/API/URLSearchParams/toString
      //https://attacomsian.com/blog/javascript-convert-object-to-query-string-parameters
      var url = "disruption_events.php?" + new URLSearchParams(inputs).toString();
      console.log(url);
      xhttp.open("GET", url, true);
      xhttp.send();
    }
  </script>

  <div id="temp"></div>

        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS and dependencies for tab functionality -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>
</body>

</html>