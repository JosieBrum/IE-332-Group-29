<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>

  <nav>
    <ul>
      <li><strong>Company Info</strong></li>
    </ul>
  </nav>

</head>

<body>

  <!-- This Defines the Form and the onsubmit calls the Javascript showCustomer() function defined below -->
  <!--form action="" onsubmit="showCustomer()">
    <input type="text" name="table" id="table" placeholder="Table">
    <input type="text" name="xv" id="xv" placeholder="X-Variable">
    <input type="text" name="yv" id="yv" placeholder="Y-Variable">
    <input type="submit">
  </form> -->

    <form action= "" onsubmit="showCustomer()">
        <input type= "text" name= "Company_name" id= "company" placeholder= "Enter a company name">
        <input type="date" name="date1" id="date1" placeholder = "Enter starting date">
        <input type= "date" name ="date2"id="date2" placeholder = "Enter ending date">
        <input type= "submit" name = "submit-btn" value="Search">
    </form>

  <!-- This Div with id=tester is used to act as a placeholder for the plot. -->
  <div id="tester" style="width:600px;height:250px;"></div>

  <script>
    // This function is in a script tag, indicating javascript, it is called when we
    // click the submit button on the form above.
    function showCustomer() {
      // These 3 strings are retrieved from the table above and joined into one string
      // separated by commas in the format the php file expects to find after the ?q=
      // part. 

      // This part gets the strings from the table.
      str = document.getElementById("company").value;
      xt = document.getElementById("date1").value;
      yt = document.getElementById("date2").value;


      // This is how you join the strings into one big one.
      str = xt + "|" + yt + "|" + str;
      console.log(str);
      


      // This thing is weird and you don't always need it, but I think you need it specifically
      // for submit button based pages.
      event.preventDefault();

      // Here is where we start defining the XHTTP request that JS uses to call the php file 
      // with the variables.
      var xhttp;
      if (str == "") {
        // If the table variable/query variable is empty, make sure we're not displaying anything in temp. 
        // This isn't necessary in this example, but could be useful for particular configurations.
        document.getElementById("temp").innerHTML = "";
        return;
      }
      // this is where we define the actual request.
      xhttp = new XMLHttpRequest();

      // This function is called when the request loads from the php file.
      xhttp.onload = function () {
        // This if statement checks if we're ready and the php file returned a "working"
        // result (i.e. html status code 200, look this up if curious or confused.)
        if (this.readyState == 4 && this.status == 200) {

          // Since we have our php file returning the code in JSON, we need to parse the string as JSON.
          // this produces a list of Key-Value-Pairs, which are indexed by the key names, which we need to grab from
          // xt and yt variable from before. We do this, in this section of the code eval(`item.${xt}`) } below.
          //nsole.log(this.responseText);
          var temp = JSON.parse(this.responseText);
          console.log(temp);
          // https://stackoverflow.com/questions/14643617/create-table-using-javascript
          function makeTableHTML(myArray) {
            var result = "<table border=1>";
            for(var i=0; i<myArray.length; i++) {
                result += "<td>"+myArray[i]+"</td>";
            }
            result += "</table>";
            return result;
          }
          //https://stackoverflow.com/questions/14643617/create-table-using-javascript
          function makeTableHTMLColoumns(myArray) {
            var result = "<table border=1><tr>";
            for(var i=0; i<myArray.length; i++) {
                result += "<tr><td>" + myArray[i] + "</td></tr>";
            }
            result +="</table>";
            return result;
          }
          //https://www.chartjs.org/docs/latest/charts/doughnut.html
          function createpiecharts(data1,data2) {
            let color = [];
            for (let i = 0; i < data1.length; i++) {
              color.push(`rgb(${Math.random()*255},${Math.random()*255},${Math.random()*255})`);
            }
            var ctx = document.getElementById("myChart");
            myChart =new Chart(ctx, {
              type: 'pie',
              data: {
              labels: data1,
              datasets: [{
              label: '% of each catagory',
              data: data2,
              borderWidth: 1,
              backgroundColor: color,
              hoverOffset: 4
              }]
            },
            });
          }

          let html = `Company Name: ${temp[0][0][0]} </br>`;
          html+= `Tier: ${temp[0][0][1]} </br>`
          html+= `Type: ${temp[0][0][2]} </br>`
          html+= `Location: ${temp[0][0][3]}, ${temp[0][0][4]}, ${temp[0][0][5]} </br>`;
          if (temp[0][0][2]=="Manufacturer"){
            html+= `Capacity: ${temp[0][1]} </br>`
            html+= `Products: </br>`;
            let products = temp[0][2];
            html += makeTableHTML(products);
            let categorie = temp[0][3];
            let categoriespercents = temp[0][4];
            html+= `Catagories: </br>`;
            html += "<table>"
            createpiecharts(categorie, categoriespercents);
          }
          if (temp[0][0][2]=="Distributor"){
            html+= `Routes: </br>`;
            let Distributors = temp[0][1];
            html += makeTableHTMLColoumns(Distributors);
          }


          var tempEl = document.getElementById("temp");
          tempEl.innerHTML = html;
        }
      };

      

      // This portion actually runs the HTTP request to the php file using the variables set in the table
      // and concatenated on line 49 into the str variable which contains x_variable,y_variable,table
      // but replace the placeholders with whatever variables/table  you're trying to query.
      var url = "company_info_output.php?q=" + encodeURIComponent(str);
      console.log(url);
      xhttp.open("GET", url, true);
      xhttp.send();
    }
  </script>

  <div id="temp"></div>
  <div style="width: 50%;"><canvas id="myChart"></canvas></div>
</body>

</html>