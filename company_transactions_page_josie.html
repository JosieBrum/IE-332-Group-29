<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css"> <!-- input form style -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css"/>
  <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet"/>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"/>

  <link rel="stylesheet" href="styles.css?v=3" />  <!-- general css style -->

  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" charset="utf-8"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  
  <style>
    /* Remove list style from nav tabs */
    .nav-tabs {
      list-style: none;
      padding-left: 0;
    }
    .nav-tabs .nav-item {
      list-style: none;
    }
    /* Add padding at bottom to create buffer */
    #wrapper {
      padding-bottom: 50px;
    }
  </style>

  <title>Company Transactions</title>

</head>

<body>

  <!-- Vertical Sidebar -->
  <div class="sidebar">
    <div class="logo">
      <img src="logo.png" alt="INSERT LOGO HERE" />
    </div>
    <ul class="nav-links">
      <li><a href="company_info_page_josie_v5.html">Company Information</a></li>
      <li><a href="disruptions_events_josie.html">Disruption Events</a></li>
      <li><a href="company_transactions_page_josie.html" class="active">Company Transactions</a></li>
      <li><a href="distributor_transactions_page_josie.html">Distributor Transactions</a></li>
      <li><a href="login_page_josie.html" style="color: #ff4560;">Log Out</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div id="wrapper">
      <div class="content-area">
        <div class="container-fluid">

     <!-- Page Title --> 
    <h3>Company Transactions</h3>

    <!-- Search Form -->
    <div class="box shadow">
      <form id="searchForm" onsubmit="event.preventDefault(); searchTransactions();">
        <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
          <select id="searchType" name="searchType" required onchange="updateSearchFields()">
            <option value="">Select search type</option>
            <option value="company">Company</option>
            <option value="continent">Continent</option>
            <option value="country">Country</option>
            <option value="city">City</option>
          </select>
          
          <div id="searchFields"></div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 10px; align-items: end;">
            <input type="date" id="startDate" name="startDate" placeholder="Enter starting date">
            <input type="date" id="endDate" name="endDate" placeholder="Enter ending date">
            <input type="submit" name="submit-btn" value="Search">
          </div>
        </div>
        <div id="errorMessage" class="mt-3" style="color: red; display: none;"></div>
      </form>
    </div>

    <!-- Results Container -->
    <div id="resultsContainer" class="mt-4" style="display: none;">
      <h5>Transaction Results</h5>
      
      <!-- Tabs for different views -->
      <ul class="nav nav-tabs" id="transactionTabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link active" id="overview-tab" data-toggle="tab" href="#overview" role="tab">Overview</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="leaving-tab" data-toggle="tab" href="#leaving" role="tab">Leaving</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="arriving-tab" data-toggle="tab" href="#arriving" role="tab">Arriving</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" id="adjustments-tab" data-toggle="tab" href="#adjustments" role="tab">Adjustments</a>
        </li>
      </ul>

      <div class="tab-content mt-3" id="transactionTabsContent">
        <div class="tab-pane fade show active" id="overview" role="tabpanel">
          <div class="box shadow">
            <div id="overviewContent">
              <!-- Overview content will be displayed here -->
              <p>Overview content coming soon</p>
            </div>
          </div>
        </div>
        
        <div class="tab-pane fade" id="leaving" role="tabpanel">
          <div class="box shadow">
            <div id="leavingContent">
              <!-- Leaving transactions will be displayed here -->
              <p>Leaving transactions content coming soon</p>
            </div>
          </div>
        </div>
        
        <div class="tab-pane fade" id="arriving" role="tabpanel">
          <div class="box shadow">
            <div id="arrivingContent">
              <!-- Arriving transactions will be displayed here -->
              <p>Arriving transactions content coming soon</p>
            </div>
          </div>
        </div>
        
        <div class="tab-pane fade" id="adjustments" role="tabpanel">
          <div class="box shadow">
            <div id="adjustmentsContent">
              <!-- Adjustments will be displayed here -->
              <p>Adjustments content coming soon</p>
            </div>
          </div>
        </div>
      </div>
    </div>

  <div id="temp"></div>

  <script>
    function updateSearchFields() {
      const searchType = document.getElementById('searchType').value;
      const searchFields = document.getElementById('searchFields');
      
      let fieldsHtml = '';
      
      if (!searchType) {
        searchFields.innerHTML = '';
        return;
      }
      
      switch(searchType) {
        case 'company':
          fieldsHtml = '<input type="text" id="companyName" name="companyName" placeholder="Enter company name" required>';
          break;
        case 'continent':
          fieldsHtml = `<select id="continent" name="continent" required>
            <option value="">Select continent</option>
            <option value="Africa">Africa</option>
            <option value="Asia">Asia</option>
            <option value="Europe">Europe</option>
            <option value="North America">North America</option>
            <option value="Oceania">Oceania</option>
            <option value="South America">South America</option>
          </select>`;
          break;
        case 'country':
          fieldsHtml = '<input type="text" id="country" name="country" placeholder="Enter country name" required>';
          break;
        case 'city':
          fieldsHtml = '<input type="text" id="city" name="city" placeholder="Enter city name" required>';
          break;
        default:
          fieldsHtml = '';
      }
      
      searchFields.innerHTML = fieldsHtml;
    }

    function searchTransactions() {
      const errorMessageDiv = document.getElementById('errorMessage');
      errorMessageDiv.style.display = 'none';
      errorMessageDiv.textContent = '';

      const searchType = document.getElementById('searchType').value;
      let startDate = document.getElementById('startDate').value;
      let endDate = document.getElementById('endDate').value;

      // Build inputs object using for loop
      const fields = ['company', 'continent', 'country', 'city', 'date1', 'date2'];
      const inputs = {};
      for (let key = 0; key < fields.length; key++) {
        const fieldId = fields[key];
        const element = document.getElementById(fieldId);
        if (element && element.value != "") {
          inputs[fieldId] = element.value;
        }
      }

      // Set default dates if not provided
      const today = new Date();
      today.setHours(0, 0, 0, 0); // Reset time to midnight for accurate comparison
      
      // If no end date provided, use today
      if (!endDate) {
        const todayStr = today.toISOString().split('T')[0];
        endDate = todayStr;
        document.getElementById('endDate').value = todayStr;
      }
      
      // If no start date provided, use 2019-01-01 (start of database)
      if (!startDate) {
        const dbStartDate = '2019-01-01';
        startDate = dbStartDate;
        document.getElementById('startDate').value = dbStartDate;
      }
      
      // Validate dates
      const start = new Date(startDate);
      const end = new Date(endDate);

      // Check if end date is before start date
      if (end < start) {
        errorMessageDiv.textContent = "The ending date cannot be before the starting date.";
        errorMessageDiv.style.display = "block";
        return;
      }

      // Check if either date is after today
      if (start > today) {
        errorMessageDiv.textContent = "The starting date cannot be after today's date.";
        errorMessageDiv.style.display = "block";
        return;
      }

      if (end > today) {
        errorMessageDiv.textContent = "The ending date cannot be after today's date.";
        errorMessageDiv.style.display = "block";
        return;
      }

      // Get search parameters based on type
      let searchParams = {
        searchType: searchType,
        startDate: startDate,
        endDate: endDate
      };

      switch(searchType) {
        case 'company':
          const companyName = document.getElementById('companyName').value.trim();
          if (!companyName) {
            errorMessageDiv.textContent = 'Please enter a company name.';
            errorMessageDiv.style.display = 'block';
            return;
          }
          searchParams.company = companyName;
          break;
        case 'continent':
          searchParams.continent = document.getElementById('continent').value;
          break;
        case 'country':
          const country = document.getElementById('country').value.trim();
          if (!country) {
            errorMessageDiv.textContent = 'Please enter a country name.';
            errorMessageDiv.style.display = 'block';
            return;
          }
          searchParams.country = country;
          break;
        case 'city':
          const city = document.getElementById('city').value.trim();
          if (!city) {
            errorMessageDiv.textContent = 'Please enter a city name.';
            errorMessageDiv.style.display = 'block';
            return;
          }
          searchParams.city = city;
          break;
      }

      // Validate company name against database if applicable
      if (searchType === 'company') {
        validateAndSearch(searchParams);
      } else if (searchType === 'country') {
        validateCountryAndSearch(searchParams);
      } else if (searchType === 'city') {
        validateCityAndSearch(searchParams);
      } else {
        performSearch(searchParams);
      }
    }

    function validateAndSearch(searchParams) {
      const errorMessageDiv = document.getElementById('errorMessage');
      const xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          const temp = JSON.parse(this.responseText);
          const companyList = temp["Company List All:"];
          
          if (companyList && !companyList.includes(searchParams.company)) {
            errorMessageDiv.textContent = 'Company "' + searchParams.company + '" not found in database.';
            errorMessageDiv.style.display = 'block';
            return;
          }
          
          performSearch(searchParams);
        }
      };
      xhttp.open("GET", "company_info_output.php?company=" + encodeURIComponent(searchParams.company), true);
      xhttp.send();
    }

    function validateCountryAndSearch(searchParams) {
      const errorMessageDiv = document.getElementById('errorMessage');
      const xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          const temp = JSON.parse(this.responseText);
          const countryList = temp["Country List All:"];
          
          if (countryList && !countryList.includes(searchParams.country)) {
            errorMessageDiv.textContent = 'Country "' + searchParams.country + '" not found in database.';
            errorMessageDiv.style.display = 'block';
            return;
          }
          
          performSearch(searchParams);
        }
      };
      xhttp.open("GET", "company_info_output.php?company=dummy", true);
      xhttp.send();
    }

    function validateCityAndSearch(searchParams) {
      const errorMessageDiv = document.getElementById('errorMessage');
      const xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          const temp = JSON.parse(this.responseText);
          const cityList = temp["City List All:"];
          
          if (cityList && !cityList.includes(searchParams.city)) {
            errorMessageDiv.textContent = 'City "' + searchParams.city + '" not found in database.';
            errorMessageDiv.style.display = 'block';
            return;
          }
          
          performSearch(searchParams);
        }
      };
      xhttp.open("GET", "company_info_output.php?", true);
      xhttp.send();
    }

    function performSearch(searchParams) {
      // Build inputs object for URL parameters
      const inputs = {
        date1: searchParams.startDate,
        date2: searchParams.endDate
      };
      
      // Add search parameter based on type
      switch(searchParams.searchType) {
        case 'company':
          inputs.company = searchParams.company;
          break;
        case 'continent':
          inputs.continent = searchParams.continent;
          break;
        case 'country':
          inputs.country = searchParams.country;
          break;
        case 'city':
          inputs.city = searchParams.city;
          break;
      }
      
      // Make API call
      const xhttp = new XMLHttpRequest();
      xhttp.onload = function() {
        if (this.readyState == 4 && this.status == 200) {
          console.log('Raw response:', this.responseText);
          try {
            const temp = JSON.parse(this.responseText);
            console.log('Parsed data:', temp);
            displayResults(temp);
          } catch (e) {
            console.error('JSON parse error:', e);
            console.error('Response was:', this.responseText);
            alert('Error: Server returned invalid data. Check console for details.');
          }
        } else {
          console.error('Request failed with status:', this.status);
        }
      };
      
      xhttp.onerror = function() {
        console.error('Network error');
      };
      
      const url = "transaction_V2.php?" + new URLSearchParams(inputs).toString();
      console.log(url);
      xhttp.open("GET", url, true);
      xhttp.send();
    }
    
    function displayResults(data) {
      const resultsContainer = document.getElementById('resultsContainer');
      const overviewContent = document.getElementById('overviewContent');
      const leavingContent = document.getElementById('leavingContent');
      const arrivingContent = document.getElementById('arrivingContent');
      
      // Calculate totals
      const leavingCount = data["Leaving Date:"] ? data["Leaving Date:"].length : 0;
      const arrivingCount = data["Entering Date:"] ? data["Entering Date:"].length : 0;
      const adjustmentCount = data["Adjustment Date:"] ? data["Adjustment Date:"].length : 0;
      const totalTransactions = leavingCount + arrivingCount + adjustmentCount;
      
      // Overview Tab
      let overviewHTML = `
        <div class="row">
          <div class="col-md-3">
            <div class="sparkbox">
              <div class="sparkbox-label">Total Transactions</div>
              <div class="sparkbox-value">${totalTransactions}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="sparkbox">
              <div class="sparkbox-label">Leaving</div>
              <div class="sparkbox-value">${leavingCount}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="sparkbox">
              <div class="sparkbox-label">Arriving</div>
              <div class="sparkbox-value">${arrivingCount}</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="sparkbox">
              <div class="sparkbox-label">Adjustments</div>
              <div class="sparkbox-value">${adjustmentCount}</div>
            </div>
          </div>
        </div>
      `;
      overviewContent.innerHTML = overviewHTML;
      
      // Leaving Tab
      if (data["Leaving Date:"] && data["Leaving Date:"].length > 0) {
        let leavingHTML = '<h6>Transactions Leaving</h6>';
        leavingHTML += '<table class="table table-striped"><thead><tr><th>Date</th><th>Company</th><th>Product</th><th>Quantity</th></tr></thead><tbody>';
        for (let i = 0; i < data["Leaving Date:"].length; i++) {
          leavingHTML += `<tr>
            <td>${data["Leaving Date:"][i]}</td>
            <td>${data["Leaving Company:"][i]}</td>
            <td>${data["Leaving Product:"][i]}</td>
            <td>${data["Leaving Quantity:"][i]}</td>
          </tr>`;
        }
        leavingHTML += '</tbody></table>';
        leavingContent.innerHTML = leavingHTML;
      } else {
        leavingContent.innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">No leaving transactions found.</p>';
      }
      
      // Arriving Tab
      if (data["Entering Date:"] && data["Entering Date:"].length > 0) {
        let arrivingHTML = '<h6>Transactions Arriving</h6>';
        arrivingHTML += '<table class="table table-striped"><thead><tr><th>Date</th><th>Company</th><th>Product</th><th>Quantity</th></tr></thead><tbody>';
        for (let i = 0; i < data["Entering Date:"].length; i++) {
          arrivingHTML += `<tr>
            <td>${data["Entering Date:"][i]}</td>
            <td>${data["Entering Company:"][i]}</td>
            <td>${data["Entering Product:"][i]}</td>
            <td>${data["Entering Quantity:"][i]}</td>
          </tr>`;
        }
        arrivingHTML += '</tbody></table>';
        arrivingContent.innerHTML = arrivingHTML;
      } else {
        arrivingContent.innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">No arriving transactions found.</p>';
      }
      
      // Adjustments Tab
      const adjustmentsContent = document.getElementById('adjustmentsContent');
      if (data["Adjustment Date:"] && data["Adjustment Date:"].length > 0) {
        let adjustmentsHTML = '<h6>Adjustments</h6>';
        adjustmentsHTML += '<table class="table table-striped"><thead><tr><th>Date</th><th>Company</th><th>Product</th><th>Quantity</th><th>Reason</th></tr></thead><tbody>';
        for (let i = 0; i < data["Adjustment Date:"].length; i++) {
          adjustmentsHTML += `<tr>
            <td>${data["Adjustment Date:"][i]}</td>
            <td>${data["Adjustment Company:"][i]}</td>
            <td>${data["Adjustment Product:"][i]}</td>
            <td>${data["Adjustment Quantity:"][i]}</td>
            <td>${data["Adjustment Reason:"][i]}</td>
          </tr>`;
        }
        adjustmentsHTML += '</tbody></table>';
        adjustmentsContent.innerHTML = adjustmentsHTML;
      } else {
        adjustmentsContent.innerHTML = '<p style="text-align: center; padding: 40px; color: #6c757d;">No adjustments found.</p>';
      }
      
      resultsContainer.style.display = 'block';
    }
  </script>

        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS and dependencies for tab functionality -->
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js"></script>
</body>

</html>

